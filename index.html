<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
    <title>ECS Dungeon Crawler</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="game-container">
    <!-- tabindex makes the canvas focusable for key events -->
    <canvas id="gameCanvas" width="800" height="700" tabindex="0"></canvas>
    <div class="controls">
        WASD/Arrows: Move | SPACE: Wait | I: Inventory | D: Drop | ENTER: Use | R: Restart | ESC: Pause
    </div>
</div>

<!-- Mobile Controls -->
<div class="mobile-controls" id="mobileControls" aria-label="Mobile controls">
    <div class="control-section">
        <div class="d-pad" role="group" aria-label="Movement">
            <button class="up" data-key="w" aria-label="Move up">↑</button>
            <button class="left" data-key="a" aria-label="Move left">←</button>
            <button class="center" data-key=" " aria-label="Wait / Space">⏸</button>
            <button class="right" data-key="d" aria-label="Move right">→</button>
            <button class="down" data-key="s" aria-label="Move down">↓</button>
        </div>
    </div>
    
    <div class="control-section">
        <div class="action-buttons" role="group" aria-label="Actions">
            <button class="action-btn primary" data-key="i" aria-label="Inventory">INV</button>
            <button class="action-btn" data-key="Enter" aria-label="Use / Enter">USE</button>
            <button class="action-btn" data-key="r" aria-label="Restart">RESTART</button>
        </div>
    </div>
</div>

<script src="globals.js"></script>
<script src="main.js"></script>

<!-- Mobile key synthesis: taps -> real KeyboardEvents -->
<script>
(function () {
  const canvas = document.getElementById('gameCanvas');
  const controlsRoot = document.getElementById('mobileControls');

  function toKeySpec(k) {
    if (k === 'Enter') return { key: 'Enter', code: 'Enter', keyCode: 13 };
    if (k === ' ')     return { key: ' ',     code: 'Space', keyCode: 32 };
    const ch = (k + '').toUpperCase();
    if (/^[A-Z]$/.test(ch)) return { key: ch.toLowerCase(), code: 'Key' + ch, keyCode: ch.charCodeAt(0) };
    return { key: k, code: k, keyCode: 0 };
  }

  function dispatchAll(type, spec) {
    const evOpts = {
      key: spec.key,
      code: spec.code,
      keyCode: spec.keyCode,
      which: spec.keyCode,
      bubbles: true,
      cancelable: true,
    };
    const targets = [window, document, document.body, canvas].filter(Boolean);
    for (const t of targets) {
      try { t.dispatchEvent(new KeyboardEvent(type, evOpts)); } catch {}
    }
  }

  function tapKey(k) {
    const spec = toKeySpec(k);
    canvas?.focus?.();
    console.log('[mobile] synth-key:', spec.code);
    dispatchAll('keydown',  spec);
    dispatchAll('keypress', spec);
    setTimeout(() => dispatchAll('keyup', spec), 0);
  }

  // Wire mobile buttons
  controlsRoot.querySelectorAll('button[data-key]').forEach(btn => {
    const k = btn.getAttribute('data-key');
    ['pointerdown','click','touchstart'].forEach(evt => {
      btn.addEventListener(evt, (e) => {
        e.preventDefault();
        tapKey(k);
      }, { passive: false });
    });
  });

  // First tap on canvas => Space (to start the game)
  ['pointerdown','click','touchstart'].forEach(evt => {
    canvas.addEventListener(evt, (e) => {
      if (!canvas.__started) {
        canvas.__started = true;
        e.preventDefault();
        tapKey(' ');
      }
    }, { passive: false, once: true });
  });

  // Ensure canvas has focus after load
  window.addEventListener('load', () => {
    setTimeout(() => canvas?.focus?.(), 0);
  });
})();
</script>
</body>
</html>
